<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FIX: Đổi tên ứng dụng -->
    <title>Kiểm tra học kì I - Lớp 10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #E0F7FA; /* Xanh da trời rất nhạt */
            color: #424242; /* Xám đậm */
            position: relative;
            overflow-x: hidden;
        }
        .safe-area { width: 100%; max-width: 85vw; margin-left: auto; margin-right: auto; }
        @media (max-width: 768px) { .safe-area { max-width: 95vw; } }
        .screen { display: none; }
        .screen.active { display: block; }
        .screen-transition { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Dropdown */
        .custom-select-options {
            transition: opacity 0.2s, transform 0.2s;
        }

        .option-card { transition: all 0.2s ease-in-out; }
        .option-card.selected { 
            background-color: #7986CB !important; /* Xanh indigo nhẹ nhàng */
            color: white !important;
            border-color: #7986CB !important; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(121, 134, 203, 0.4);
        }
        .tf-btn.selected { 
            outline: 2px solid #7986CB;
            outline-offset: 2px;
        }

        /* Review Screen Styles */
        .review-option.correct { background-color: #E8F5E9; border-color: #4CAF50; }
        .review-option.incorrect { background-color: #FFEBEE; border-color: #F44336; }
        .review-option.missed-correct { background-color: #E8F5E9; border: 2px dashed #4CAF50; }
        .review-tf-btn.correct { background-color: #4CAF50; color: white; }
        .review-tf-btn.incorrect { background-color: #F44336; color: white; }
    </style>
</head>
<body>

    <main class="w-full max-w-3xl mx-auto p-4 py-8">
        <!-- Màn hình Đăng nhập -->
        <div id="login-screen" class="screen active">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10 safe-area">
                <div class="text-center mb-8">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">KIỂM TRA HỌC KÌ I NĂM HỌC 2025 – 2026</h1>
                    <p class="text-base md:text-lg font-semibold text-gray-600 mt-2">MÔN: Tin học – LỚP: 10</p>
                    <p class="text-sm md:text-base text-[#5C6BC0] font-medium mt-2">Thời gian làm bài: 5 phút</p>
                </div>
                <div class="space-y-6">
                    <p class="text-center text-gray-700">Vui lòng chọn đúng thông tin của em để bắt đầu.</p>
                    
                    <!-- Custom Select Lớp -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">1. Chọn lớp</label>
                        <div class="relative">
                            <button type="button" id="class-select-button" class="w-full text-left px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#7986CB] transition flex justify-between items-center">
                                <span class="text-gray-500">-- Vui lòng chọn lớp --</span>
                                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div id="class-select-options" class="custom-select-options absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-xl shadow-lg hidden opacity-0 transform scale-95"></div>
                        </div>
                    </div>

                    <!-- Custom Select Tên -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">2. Chọn tên của em</label>
                        <div class="relative">
                             <button type="button" id="student-select-button" class="w-full text-left px-4 py-3 bg-gray-200 border border-gray-300 rounded-xl transition flex justify-between items-center cursor-not-allowed" disabled>
                                <span class="text-gray-500">-- Vui lòng chọn tên --</span>
                                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div id="student-select-options" class="custom-select-options absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-xl shadow-lg hidden opacity-0 transform scale-95"></div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button id="start-button" class="w-full bg-[#7986CB] text-white font-bold py-3 px-4 rounded-xl hover:bg-[#5C6BC0] focus:outline-none focus:ring-4 focus:ring-[#C5CAE9] transition-all disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none shadow-lg shadow-indigo-500/30" disabled>Bắt đầu làm bài</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Màn hình Làm bài -->
        <div id="quiz-screen" class="screen">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 safe-area">
                <div class="flex justify-between items-center border-b border-gray-200 pb-4 mb-6">
                    <span id="question-counter" class="font-bold text-lg text-[#3F51B5]"></span>
                    <div class="flex items-center space-x-2 bg-red-100 text-red-700 font-bold px-4 py-2 rounded-full">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span id="timer">05:00</span>
                    </div>
                </div>
                <div id="instruction-area" class="bg-indigo-50 p-4 rounded-lg mb-6 text-indigo-800 border border-indigo-200"></div>
                <div id="question-area">
                    <p id="question-text" class="text-lg font-semibold text-gray-800 mb-6"></p>
                    <div id="options-container" class="space-y-3"></div>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <button id="next-button" class="w-full bg-[#7986CB] text-white font-bold py-3 px-4 rounded-xl hover:bg-[#5C6BC0] focus:outline-none focus:ring-4 focus:ring-[#C5CAE9] transition-all disabled:bg-gray-400"></button>
                </div>
            </div>
        </div>
        
        <!-- Màn hình Kết quả -->
        <div id="result-screen" class="screen">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10 safe-area screen-transition space-y-8">
                <div class="text-center">
                    <h2 class="text-4xl font-extrabold text-green-500">Hoàn thành!</h2>
                    <p id="result-greeting" class="mt-2 text-lg text-gray-700"></p>
                    <div class="mt-6 bg-gray-50 p-6 rounded-xl inline-block border border-gray-200">
                        <p class="text-sm font-medium text-gray-500">Điểm số của bạn</p>
                        <p id="final-score" class="text-5xl font-extrabold text-[#3F51B5] my-1"></p>
                        <p id="time-taken" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="copy-button" class="bg-gray-700 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-800 transition-all duration-200 inline-block">Sao chép kết quả</button>
                        <p id="copy-feedback" class="text-sm text-green-600 mt-2 opacity-0 transition-opacity">Đã sao chép thành công!</p>
                    </div>
                </div>
                <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-200">
                    <h3 class="text-xl font-bold text-indigo-800 mb-3">Nhận xét bài làm</h3>
                    <div id="feedback-content" class="text-indigo-900 space-y-4"></div>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Xem lại bài làm</h3>
                    <div id="review-container" class="space-y-6"></div>
                </div>
                <div class="text-center pt-6 border-t border-gray-200">
                    <button id="end-button" class="bg-red-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all">Kết thúc</button>
                </div>
            </div>
        </div>
    </main>

    <script>
    // --- CSDL MÔ PHỎNG ---
    const studentData = { "10A1": ["Nguyễn Văn A", "Trần Thị B", "Phạm Văn C", "Bùi Thị Hồng Thu", "Nguyễn Tô Sơn"], "10A2": ["Lê Thị D", "Hoàng Văn E", "Vũ Thị F"] };
    const quizData = {
        mc: [
            { id: 1, topic: "Python: Vòng lặp", question: "Phương án nào dưới đây mô tả sự khác biệt giữa câu lệnh lặp for và while trong Python?", options: ["Câu lệnh for được sử dụng khi số lần lặp không xác định, còn while được sử dụng khi số lần lặp đã biết.", "Câu lệnh for được sử dụng khi biết số lần lặp và có thể lặp qua một dãy giá trị, trong khi while không biết trước số lần lặp, lặp khi điều kiện tiếp tục được thỏa mãn.", "Cả for và while đều dùng để lặp qua một dây giá trị xác định.", "Câu lệnh for không thể lặp vô hạn, trong khi while có thể."], answer: 1 },
            { id: 2, topic: "Python: Hàm & Thư viện", question: "Khi gọi một hàm có tham số nhưng không gán giá trị mặc định cho tham số thì điều gì sẽ xảy ra dưới đây nếu không truyền đủ số lượng đối số cho tham số trong lời gọi hàm?", options: ["Python sẽ tự động gán giá trị None cho các tham số thiếu.", "Chương trình sẽ báo lỗi TypeError.", "Chương trình bỏ qua tham số thiếu và tiếp tục chạy.", "Python sẽ tự động điền giá trị mặc định 0."], answer: 1 },
            { id: 3, topic: "Python: Hàm & Thư viện", question: "Phương án nào sau đây đúng khi nói về hàm abs() trong Python?", options: ["Hàm abs() trả về phần thực của một số phức.", "Hàm abs() trả về giá trị tuyệt đối của một số.", "Hàm abs() trả về giá trị âm của một số.", "Hàm abs() trả về phần nguyên của một số thực."], answer: 1 },
            { id: 4, topic: "Python: Chuỗi & Danh sách", question: "Khi sử dụng hàm len(s) với một xâu kí tự s, kết quả trả về là gì?", options: ["Số kí tự trong xâu, bao gồm cả dấu cách", "Số lượng từ có trong xâu", "Chỉ tính các kí tự chữ cái trong xâu", "Độ dài tối đa mà xâu có thể chứa"], answer: 0 },
            { id: 5, topic: "Python: Chuỗi & Danh sách", question: "Cho đoạn lệnh Python sau:\ny = \"abcdef\"\nprint(y[:4])\nKết quả nào sau đây là đúng khi thực hiện đoạn lệnh trên?", options: ["abcd", "bcde", "abc", "abcdef"], answer: 0 },
            { id: 6, topic: "Python: Chuỗi & Danh sách", question: "Phương án nào sau đây mô tả đúng cách truy cập phần tử trong danh sách A tại vị trí chỉ số 2?", options: ["A<2>", "A(2)", "A{2}", "A[2]"], answer: 3 },
            { id: 7, topic: "Python: Chuỗi & Danh sách", question: "Cho danh sách sau:\nA = [\"apple\", \"banana\", \"cherry\", \"date\", \"elderberry\", \"fig\", \"grape\"]\nPhương án nào sau đây nêu đúng giá trị của phần tử A[5]?", options: ["\"elderberry\"", "\"grape\"", "\"fig\"", "\"date\""], answer: 2 },
            { id: 8, topic: "Lập trình: Khái niệm & Gỡ lỗi", question: "Phương án nào sau đây điền từ đúng vào chỗ trống:\n\"... là một lỗi khi chương trình không tuân theo các quy định ngữ pháp của ngôn ngữ lập trình\"?", options: ["Lỗi ngữ nghĩa.", "Lỗi cú pháp.", "Lỗi logic.", "Lỗi ngoại lệ."], answer: 1 },
            { id: 9, topic: "Lập trình: Khái niệm & Gỡ lỗi", question: "Phát biểu nào sau đây giải thích tại sao việc kiểm thử chương trình lại quan trọng trong quá trình lập trình?", options: ["Kiểm thử giúp đảm bảo rằng chương trình đã hoàn chỉnh và có thể chạy ngay lập tức mà không cần thay đổi gì.", "Kiểm thử giúp xác định lỗi và điều chỉnh chương trình để đảm bảo kết quả đúng với yêu cầu bài toán.", "Kiểm thử không cần thiết nếu chương trình chạy đúng ở lần đầu tiên.", "Kiểm thử chỉ cần thiết khi chương trình đã hoàn thành 100%."], answer: 1 },
            { id: 10, topic: "Lập trình: Khái niệm & Gỡ lỗi", question: "Tại sao việc xác định cách tổ chức dữ liệu là một phần quan trọng trong bước tìm thuật toán?", options: ["Để làm cho chương trình nhanh hơn mà không cần tính toán.", "Để chọn được ngôn ngữ lập trình thích hợp cho bài toán.", "Để đảm bảo rằng thuật toán có thể hoạt động trên các cấu trúc dữ liệu phù hợp.", "Để giải quyết bài toán mà không cần kiểm thử chương trình."], answer: 2 },
            { id: 11, topic: "Thiết kế đồ họa: GIMP", question: "Phương án nào sau đây là vai trò của phần mềm GIMP trong việc thiết kế đồ họa?", options: ["Quản lý các tệp ảnh và lưu trữ chúng", "Cung cấp các công cụ thiết kế đồ họa như tạo văn bản, tô màu, ghép ảnh", "Tạo ra các phần mềm di động", "Hỗ trợ chỉnh sửa video"], answer: 1 },
            { id: 12, topic: "Thiết kế đồ họa: GIMP", question: "Trong GIMP, nếu một điểm ảnh có giá trị kênh alpha là 0 thì điều này có nghĩa gì sau đây?", options: ["Điểm ảnh đó có màu đen.", "Điểm ảnh đó có màu trắng.", "Điểm ảnh đó không hiển thị.", "Điểm ảnh đó hiển thị mở."], answer: 2 }
        ],
        tf: [
            { id: 13, topic: "Python: Hàm & Thư viện", question: "Trong một giờ học lập trình Python, thầy giáo giới thiệu cho các bạn học sinh lớp 10A về thư viện hàm có sẵn. Muốn sử dụng các hàm này chỉ cần kết nối hàm hoặc thư viện chứa hàm với chương trình, gọi đến hàm và truyền vào giá trị cho các tham số trong hàm. Các bạn học sinh sau khi nghe phân tích của thầy đã đưa ra một số nhận xét sau:", options: [{ text: "Trong Python, thư viện là một tập hợp gồm một số hàm đã được xây dựng sẵn.", answer: "Đ" }, { text: "Các hàm có sẵn trong Python được sử dụng luôn trong chương trình, không cần kết nối hàm hay thư viện chứa hàm với chương trình.", answer: "S" }, { text: "Khi thực hiện lời gọi hàm, bất kể hàm nào cũng cần truyền vào giá trị cho tham số để hàm thực hiện.", answer: "S" }, { text: "Python hỗ trợ nhiều hàm có sẵn giúp cho người lập trình viết chương trình nhanh gọn, không cần phải xây dựng các đoạn lệnh dài và phức tạp.", answer: "Đ" }] },
            { id: 14, topic: "Python: Chuỗi & Danh sách", question: "Một nhóm học sinh đang thực hiện bài tập sắp xếp danh sách A các điểm số của mình trong Python. Sau khi nhập các điểm số vào danh sách, nhóm học sinh muốn sắp xếp các điểm số theo thứ tự tăng dần. Các bạn học sinh đã đưa ra các nhận xét sau:", options: [{ text: "Hàm A.sort() chỉ sắp xếp danh sách theo thứ tự tăng dần.", answer: "S" }, { text: "Hàm A.sort() chỉ có thể được sử dụng với các danh sách chứa các phần tử cùng kiểu dữ liệu.", answer: "S" }, { text: "Khi thực hiện sắp xếp bằng hàm A.sort(), danh sách sẽ được thay đổi trực tiếp và không cần phải gán lại giá trị cho danh sách.", answer: "Đ" }, { text: "Để sắp xếp danh sách điểm theo thứ tự không giảm, có thể dùng lệnh A.sort().", answer: "Đ" }] },
            { id: 15, topic: "Lập trình: Kỹ năng nghề nghiệp", question: "Một công ty công nghệ đang tổ chức hội thảo về nghề lập trình để tuyển dụng nhân sự trẻ. Sau khi tham gia hội thảo, số ứng viên đã có những nhận xét sau:", options: [{ text: "Công việc lập trình chỉ liên quan đến việc viết mã, không đòi hỏi sự kiên trì hay khả năng chịu áp lực.", answer: "S" }, { text: "Việc lập trình không đơn giản chỉ là viết mã, mà còn bao gồm gỡ lỗi, tối ưu hóa và kiểm thử phần mềm.", answer: "Đ" }, { text: "Lập trình viên thường phải làm việc với nhiều dự án cùng lúc và có thời hạn chặt chẽ.", answer: "Đ" }, { text: "Một lập trình viên giỏi không chỉ cần kỹ năng chuyên môn mà còn phải có khả năng giao tiếp để làm việc hiệu quả trong nhóm.", answer: "Đ" }] },
            { id: 16, topic: "Thiết kế đồ họa: GIMP", question: "An được giao nhiệm vụ thiết kế logo cho câu lạc bộ Tin học của trường bằng phần mềm GIMP. Logo gồm hình ảnh một chú chim cánh cụt đang đứng trên quả địa cầu. An đã vẽ hình chú chim cánh cụt trên một lớp và hình quả địa cầu trên một lớp khác. Khi An muốn di chuyển hình chú chim cánh cụt lên trên một chút so với quả địa cầu, bạn ấy nên thực hiện thao tác nào sau đây?", options: [{ text: "Công cụ Move Tool dùng để di chuyển các đối tượng được chọn.", answer: "S" }, { text: "Hình chú chim cánh cụt và hình quả địa cầu nằm trên hai lớp khác nhau, do đó có thể di chuyển độc lập.", answer: "Đ" }, { text: "Có thể di chuyển đồng thời cả hai hình ảnh cùng lúc sang vị trí khác so với ban đầu bằng cách nhóm hai lớp lại với nhau.", answer: "S" }, { text: "Muốn di chuyển hình chú chim cánh cụt lên trên một chút so với quả địa cầu, An không cần di chuyển lớp, chỉ cần di chuyển hình vẽ chú chim cánh cụt trên lớp ảnh tương ứng.", answer: "S" }] }
        ]
    };

    const resourceMap = {
        "Python: Vòng lặp": {
            advice: "Em cần phân biệt rõ khi nào dùng `for` (khi biết trước số lần lặp hoặc lặp qua một danh sách) và khi nào dùng `while` (khi lặp theo một điều kiện chưa biết trước).",
            links: [
                { title: "Bài 13: Vòng lặp While, For (Tiếng Việt)", url: "https://howkteam.com/lessons/cau-truc-lap-trong-python-while-for-break-continue-pass" },
                { title: "Python Loops (English)", url: "https://www.w3schools.com/python/python_while_loops.asp" },
                { title: "Video: Vòng lặp For & While (YouTube)", url: "https://www.youtube.com/watch?v=p33xCAt3vsc" }
            ]
        },
        "Python: Hàm & Thư viện": {
            advice: "Hãy xem lại cách định nghĩa hàm, việc truyền tham số bắt buộc và tham số tùy chọn. Việc hiểu rõ lỗi `TypeError` khi thiếu tham số là rất quan trọng.",
            links: [
                { title: "Bài 15: Hàm trong Python (Tiếng Việt)", url: "https://howkteam.com/lessons/ham-trong-python-function" },
                { title: "Python Functions (English)", url: "https://www.w3schools.com/python/python_functions.asp" },
                { title: "Video: Tất tần tật về Hàm (YouTube)", url: "https://www.youtube.com/watch?v=I-n8_S-V6_o" }
            ]
        },
        "Python: Chuỗi & Danh sách": {
            advice: "Em cần ôn lại cách truy cập các phần tử trong chuỗi và danh sách bằng chỉ số (index), bao gồm cả cách cắt chuỗi/danh sách (slicing) và các hàm thông dụng.",
            links: [
                { title: "Bài 9: Kiểu dữ liệu List (Tiếng Việt)", url: "https://howkteam.com/lessons/kieu-du-lieu-list-trong-python-va-cac-phuong-thuc-xu-ly" },
                { title: "Python Lists (English)", url: "https://www.w3schools.com/python/python_lists.asp" },
                { title: "Video: List và String trong Python (YouTube)", url: "https://www.youtube.com/watch?v=x16QYI-O2Ak" }
            ]
        },
        "Lập trình: Khái niệm & Gỡ lỗi": {
            advice: "Việc phân biệt các loại lỗi (cú pháp, logic) và hiểu tầm quan trọng của việc kiểm thử là nền tảng. Hãy chắc chắn em nắm rõ các khái niệm cơ bản này.",
            links: [
                { title: "Các khái niệm lập trình cơ bản (Tiếng Việt)", url: "https://blog.topcv.vn/cac-khai-niem-lap-trinh-co-ban/" },
                { title: "Debugging in Python (English)", url: "https://realpython.com/python-debugging-pdb/" },
                { title: "Video: Debugging là gì? (YouTube)", url: "https://www.youtube.com/watch?v=p8R4zdaA_gA" }
            ]
        },
        "Thiết kế đồ họa: GIMP": {
            advice: "Em cần xem lại khái niệm về các lớp (layers) và kênh alpha (trong suốt) trong GIMP. Đây là những kiến thức cốt lõi để chỉnh sửa ảnh hiệu quả.",
            links: [
                { title: "GIMP cơ bản: Làm việc với Layer (Tiếng Việt)", url: "https://quantrimang.com/gimp-co-ban-bai-6-lam-viec-voi-layer-126895" },
                { title: "GIMP Official Tutorials (English)", url: "https://www.gimp.org/tutorials/" },
                { title: "Video: Hướng dẫn GIMP cho người mới (YouTube)", url: "https://www.youtube.com/watch?v=s43_KqA_m44" }
            ]
        },
        "Lập trình: Kỹ năng nghề nghiệp": {
            advice: "Hãy nhớ rằng lập trình không chỉ là viết code. Các kỹ năng mềm như làm việc nhóm, giao tiếp và quản lý thời gian cũng vô cùng quan trọng.",
            links: [
                { title: "9 Kỹ năng mềm IT cần có (Tiếng Việt)", url: "https://itviec.com/blog/9-ky-nang-mem-it-ban-can-biet/" },
                { title: "Essential Soft Skills for Developers (English)", url: "https://www.freecodecamp.org/news/soft-skills-for-software-developers/" },
                { title: "Video: Kỹ năng mềm cho lập trình viên (YouTube)", url: "https://www.youtube.com/watch?v=stq_I2pS_js" }
            ]
        }
    };

    // --- BIẾN TOÀN CỤC ---
    let shuffledQuestions = [], currentUser = { class: null, name: null }, userAnswers = [], completedStudents = [];
    let currentQuestionIndex = 0, timerInterval, timeRemaining = 5 * 60;

    // --- LẤY CÁC THÀNH PHẦN GIAO DIỆN ---
    const loginScreen = document.getElementById('login-screen'), quizScreen = document.getElementById('quiz-screen'), resultScreen = document.getElementById('result-screen');
    const classSelectBtn = document.getElementById('class-select-button'), studentSelectBtn = document.getElementById('student-select-button');
    const classSelectOptions = document.getElementById('class-select-options'), studentSelectOptions = document.getElementById('student-select-options');
    const startButton = document.getElementById('start-button');
    const questionCounter = document.getElementById('question-counter'), timerDisplay = document.getElementById('timer'), instructionArea = document.getElementById('instruction-area');
    const questionText = document.getElementById('question-text'), optionsContainer = document.getElementById('options-container'), nextButton = document.getElementById('next-button');
    const resultGreeting = document.getElementById('result-greeting'), finalScore = document.getElementById('final-score'), timeTakenEl = document.getElementById('time-taken');
    const copyButton = document.getElementById('copy-button'), copyFeedback = document.getElementById('copy-feedback'), feedbackContent = document.getElementById('feedback-content');
    const reviewContainer = document.getElementById('review-container'), endButton = document.getElementById('end-button');

    // --- LOGIC ---
    const shuffleArray = arr => { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; };
    const switchScreen = id => { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active', 'screen-transition')); const t = document.getElementById(id); if(t){ t.classList.add('active'); setTimeout(() => t.classList.add('screen-transition'), 10); } };

    // --- MÀN HÌNH ĐĂNG NHẬP (VỚI CUSTOM DROPDOWN) ---
    function toggleDropdown(optionsElement) {
        if (optionsElement.classList.contains('hidden')) {
            optionsElement.classList.remove('hidden');
            setTimeout(() => optionsElement.classList.remove('opacity-0', 'scale-95'), 10);
        } else {
            optionsElement.classList.add('opacity-0', 'scale-95');
            setTimeout(() => optionsElement.classList.add('hidden'), 200);
        }
    }

    function initLoginScreen() {
        switchScreen('login-screen');
        completedStudents = JSON.parse(localStorage.getItem('completedStudents_tin10_hk1')) || [];
        
        // Reset buttons
        classSelectBtn.firstElementChild.textContent = '-- Vui lòng chọn lớp --';
        classSelectBtn.firstElementChild.classList.add('text-gray-500');
        studentSelectBtn.firstElementChild.textContent = '-- Vui lòng chọn tên --';
        studentSelectBtn.firstElementChild.classList.add('text-gray-500');
        studentSelectBtn.disabled = true;
        studentSelectBtn.classList.add('bg-gray-200', 'cursor-not-allowed');

        // Populate class options
        classSelectOptions.innerHTML = '';
        Object.keys(studentData).forEach(c => {
            const optionDiv = document.createElement('a');
            optionDiv.href = '#';
            optionDiv.className = 'block px-4 py-2 text-gray-700 hover:bg-indigo-50';
            optionDiv.textContent = `Lớp ${c}`;
            optionDiv.dataset.value = c;
            optionDiv.addEventListener('click', (e) => {
                e.preventDefault();
                handleClassChange(c, `Lớp ${c}`);
                toggleDropdown(classSelectOptions);
            });
            classSelectOptions.appendChild(optionDiv);
        });
    }

    function handleClassChange(classValue, classText) {
        currentUser.class = classValue;
        classSelectBtn.firstElementChild.textContent = classText;
        classSelectBtn.firstElementChild.classList.remove('text-gray-500');

        studentSelectOptions.innerHTML = '';
        studentSelectBtn.firstElementChild.textContent = '-- Vui lòng chọn tên --';
        studentSelectBtn.firstElementChild.classList.add('text-gray-500');
        currentUser.name = null;

        if (classValue) {
            studentSelectBtn.disabled = false;
            studentSelectBtn.classList.remove('bg-gray-200', 'cursor-not-allowed');
            studentSelectBtn.classList.add('bg-gray-50');
            const students = studentData[classValue];
            students.forEach(studentName => {
                const studentId = `${classValue}-${studentName}`;
                if (!completedStudents.includes(studentId)) {
                    const optionDiv = document.createElement('a');
                    optionDiv.href = '#';
                    optionDiv.className = 'block px-4 py-2 text-gray-700 hover:bg-indigo-50';
                    optionDiv.textContent = studentName;
                    optionDiv.dataset.value = studentName;
                    optionDiv.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleStudentChange(studentName);
                        toggleDropdown(studentSelectOptions);
                    });
                    studentSelectOptions.appendChild(optionDiv);
                }
            });
        } else {
            studentSelectBtn.disabled = true;
            studentSelectBtn.classList.add('bg-gray-200', 'cursor-not-allowed');
            studentSelectBtn.classList.remove('bg-gray-50');
        }
        updateStartState();
    }
    
    function handleStudentChange(studentName) {
        currentUser.name = studentName;
        studentSelectBtn.firstElementChild.textContent = studentName;
        studentSelectBtn.firstElementChild.classList.remove('text-gray-500');
        updateStartState();
    }

    const updateStartState = () => { startButton.disabled = !(currentUser.class && currentUser.name); };

    // --- MÀN HÌNH LÀM BÀI ---
    function startQuiz() {
        switchScreen('quiz-screen');
        const shuffledMC = shuffleArray([...quizData.mc]); const shuffledTF = shuffleArray([...quizData.tf]);
        shuffledQuestions = [...shuffledMC, ...shuffledTF];
        userAnswers = new Array(shuffledQuestions.length).fill(null);
        currentQuestionIndex = 0; timeRemaining = 5 * 60;
        startTimer(); displayQuestion();
    }
    
    function startTimer() {
        timerInterval = setInterval(() => {
            timeRemaining--;
            const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
            const seconds = (timeRemaining % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
            if (timeRemaining <= 0) { clearInterval(timerInterval); submitQuiz(); }
        }, 1000);
    }

    function displayQuestion() {
        nextButton.disabled = true;
        const questionData = shuffledQuestions[currentQuestionIndex];
        const totalQuestions = shuffledQuestions.length;
        const isMC = typeof questionData.options[0] === 'string';
        questionCounter.textContent = `Câu ${currentQuestionIndex + 1}/${totalQuestions}`;
        questionText.innerHTML = `<b class="text-[#3F51B5]">Câu ${currentQuestionIndex + 1}:</b> ${questionData.question.replace(/\n/g, '<br>')}`;
        optionsContainer.innerHTML = '';
        instructionArea.style.display = 'none';
        const mcCount = quizData.mc.length;
        if (currentQuestionIndex === 0) { instructionArea.innerHTML = `<h3 class="font-bold">Phần 1: Trắc nghiệm nhiều phương án lựa chọn</h3><p class="text-sm">Từ câu 1 đến câu ${mcCount}, mỗi câu học sinh chỉ chọn một phương án trả lời.</p>`; instructionArea.style.display = 'block'; } 
        else if (currentQuestionIndex === mcCount) { instructionArea.innerHTML = `<h3 class="font-bold">Phần 2: Trắc nghiệm đúng sai</h3><p class="text-sm">Từ câu ${mcCount + 1} đến câu ${totalQuestions}, mỗi câu có 4 phương án, học sinh chọn Đúng hoặc Sai cho từng phương án.</p>`; instructionArea.style.display = 'block'; }
        if (isMC) { displayMCQuestion(questionData); } else { displayTFQuestion(questionData); }
        nextButton.textContent = currentQuestionIndex === totalQuestions - 1 ? 'Nộp bài và xem kết quả' : 'Tiếp theo';
    }

    function displayMCQuestion(q) {
        const optionsToShuffle = q.options.map((opt, i) => ({ text: opt, originalIndex: i }));
        q.shuffledOrder = shuffleArray(optionsToShuffle).map(opt => opt.originalIndex);
        const optionLabels = ['A.', 'B.', 'C.', 'D.'];
        q.shuffledOrder.forEach((originalIndex, displayIndex) => {
            const card = document.createElement('div');
            card.className = 'option-card p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-100';
            card.innerHTML = `<span class="font-bold mr-2 text-[#5C6BC0]">${optionLabels[displayIndex]}</span> ${q.options[originalIndex]}`;
            card.addEventListener('click', () => { document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected')); card.classList.add('selected'); userAnswers[currentQuestionIndex] = originalIndex; nextButton.disabled = false; });
            optionsContainer.appendChild(card);
        });
    }

    function displayTFQuestion(q) {
        const optionLabels = ['a)', 'b)', 'c)', 'd)'];
        userAnswers[currentQuestionIndex] = new Array(q.options.length).fill(null);
        q.options.forEach((opt, i) => {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
            item.innerHTML = `<p><span class="font-bold mr-2 text-[#5C6BC0]">${optionLabels[i]}</span> ${opt.text}</p><div class="flex space-x-2 flex-shrink-0"><button data-choice="Đ" class="tf-btn px-4 py-1.5 text-sm font-semibold rounded-md bg-green-100 text-green-800 hover:bg-green-200 transition">Đúng</button><button data-choice="S" class="tf-btn px-4 py-1.5 text-sm font-semibold rounded-md bg-red-100 text-red-800 hover:bg-red-200 transition">Sai</button></div>`;
            const buttons = item.querySelectorAll('.tf-btn');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    buttons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    userAnswers[currentQuestionIndex][i] = button.dataset.choice;
                    if (userAnswers[currentQuestionIndex].every(ans => ans !== null)) { nextButton.disabled = false; }
                });
            });
            optionsContainer.appendChild(item);
        });
    }

    const handleNextButtonClick = () => { currentQuestionIndex < shuffledQuestions.length - 1 ? (currentQuestionIndex++, displayQuestion()) : submitQuiz(); };

    // --- MÀN HÌNH KẾT QUẢ ---
    function submitQuiz() {
        clearInterval(timerInterval);
        const totalTime = 5 * 60; const timeTaken = totalTime - timeRemaining;
        const minutes = Math.floor(timeTaken / 60).toString().padStart(2, '0');
        const seconds = (timeTaken % 60).toString().padStart(2, '0');
        const timeString = `${minutes}:${seconds}`;

        let score = 0;
        const totalMC = quizData.mc.length, totalTF = quizData.tf.length;
        const maxScore = (totalMC * 0.25) + (totalTF * 1);
        let incorrectTopics = {};
        let correctTopics = {};

        shuffledQuestions.forEach((q, index) => {
            const userAnswer = userAnswers[index];
            let isCorrect = false;
            if (q.hasOwnProperty('shuffledOrder')) { // MC question
                if (userAnswer === q.answer) { score += 0.25; isCorrect = true; }
            } else { // TF question
                let correctInTf = 0;
                if(userAnswer) {
                    userAnswer.forEach((ans, optIndex) => { if (ans === q.options[optIndex].answer) correctInTf++; });
                }
                if (correctInTf === 4) { score += 1; isCorrect = true; }
                else if (correctInTf === 3) score += 0.5;
                else if (correctInTf === 2) score += 0.25;
                else if (correctInTf === 1) score += 0.1;
            }
            if(isCorrect) {
                correctTopics[q.topic] = (correctTopics[q.topic] || 0) + 1;
            } else {
                incorrectTopics[q.topic] = (incorrectTopics[q.topic] || 0) + 1;
            }
        });
        score = Math.round(score * 100) / 100;

        resultGreeting.textContent = `Đây là kết quả bài làm của bạn, ${currentUser.name}.`;
        finalScore.textContent = `${score}/${maxScore}`;
        timeTakenEl.textContent = `Thời gian làm bài: ${timeString}`;

        generateFeedback(correctTopics, incorrectTopics);
        generateReview();
        const studentId = `${currentUser.class}-${currentUser.name}`;
        if (!completedStudents.includes(studentId)) {
            completedStudents.push(studentId);
            localStorage.setItem('completedStudents_tin10_hk1', JSON.stringify(completedStudents));
        }
        switchScreen('result-screen');
    }
    
    function generateFeedback(correctTopics, incorrectTopics) {
        let feedbackHTML = '<div>';
        
        feedbackHTML += '<h4 class="font-bold text-lg text-green-700">✅ Ưu điểm</h4>';
        if (Object.keys(incorrectTopics).length === 0) {
            feedbackHTML += '<p>✨ Xuất sắc! Em đã trả lời đúng tất cả các câu hỏi. Em đã nắm rất vững kiến thức và có kỹ năng làm bài tuyệt vời.</p>';
        } else {
            let strengths = Object.keys(correctTopics).filter(topic => !incorrectTopics[topic]);
            if (strengths.length > 0) {
                feedbackHTML += `<p>Em đã làm rất tốt và nắm vững kiến thức ở các chủ đề: <b>${strengths.join(', ')}</b>.</p>`;
            } else {
                feedbackHTML += '<p>Em đã có sự cố gắng trong bài làm. Hãy xem các phân tích dưới đây để cải thiện hơn nhé.</p>';
            }
        }
        feedbackHTML += '</div>';

        if (Object.keys(incorrectTopics).length > 0) {
            feedbackHTML += '<div class="mt-4">';
            feedbackHTML += '<h4 class="font-bold text-lg text-red-700">❌ Nhược điểm</h4>';
            feedbackHTML += '<p>Em cần xem lại và củng cố thêm kiến thức ở các chủ đề sau:</p><ul class="list-disc list-inside mt-2">';
            for (const topic in incorrectTopics) {
                feedbackHTML += `<li><b>${topic}:</b> còn sai ${incorrectTopics[topic]} câu.</li>`;
            }
            feedbackHTML += '</ul></div>';
        }

        if (Object.keys(incorrectTopics).length > 0) {
            feedbackHTML += '<div class="mt-4">';
            feedbackHTML += '<h4 class="font-bold text-lg text-blue-700">💡 Lộ trình học tập đề xuất</h4>';
            feedbackHTML += '<p>Để cải thiện điểm số, em hãy tập trung vào các phần kiến thức còn yếu:</p><ul class="list-disc list-inside mt-2 space-y-3">';
            for (const topic in incorrectTopics) {
                const resource = resourceMap[topic];
                if (resource) {
                    feedbackHTML += `<li><b>Với chủ đề "${topic}":</b>
                        <ul class="list-inside ml-4 text-sm space-y-1 mt-1">
                            <li>- <b>Lời khuyên:</b> ${resource.advice}</li>
                            <li>- <b>Tài liệu tham khảo:</b> ${resource.links.map(l => `<a href="${l.url}" target="_blank" class="text-indigo-600 hover:underline">${l.title}</a>`).join('; ')}</li>
                        </ul>
                    </li>`;
                }
            }
            feedbackHTML += '</ul></div>';
        }
        
        feedbackContent.innerHTML = feedbackHTML;
    }

    function generateReview() {
        reviewContainer.innerHTML = '';
        shuffledQuestions.forEach((q, index) => {
            const isMC = q.hasOwnProperty('shuffledOrder');
            const reviewBlock = document.createElement('div');
            reviewBlock.className = 'p-4 border border-gray-200 rounded-lg';
            let optionsHTML = `<p class="text-md font-semibold mb-3"><b class="text-[#3F51B5]">Câu ${index + 1} (${q.topic}):</b> ${q.question.replace(/\n/g, '<br>')}</p><div class="space-y-2">`;
            
            if (isMC) {
                const optionLabels = ['A.', 'B.', 'C.', 'D.'];
                q.shuffledOrder.forEach((originalIndex, displayIndex) => {
                    const userChoice = userAnswers[index];
                    const isCorrect = originalIndex === q.answer;
                    const isSelected = originalIndex === userChoice;
                    let classes = 'review-option p-3 border border-gray-200 rounded-md';
                    if (isSelected && isCorrect) classes += ' correct';
                    else if (isSelected && !isCorrect) classes += ' incorrect';
                    else if (isCorrect) classes += ' missed-correct';
                    optionsHTML += `<div class="${classes}"><span class="font-bold mr-2 text-[#5C6BC0]">${optionLabels[displayIndex]}</span> ${q.options[originalIndex]}</div>`;
                });
            } else { // TF
                const optionLabels = ['a)', 'b)', 'c)', 'd)'];
                q.options.forEach((opt, optIndex) => {
                    const userChoice = userAnswers[index] ? userAnswers[index][optIndex] : null;
                    const isCorrect = userChoice === opt.answer;
                    let trueBtnClass = 'tf-btn px-3 py-1 text-sm rounded';
                    let falseBtnClass = 'tf-btn px-3 py-1 text-sm rounded';

                    if(userChoice === 'Đ') {
                        trueBtnClass += isCorrect ? ' review-tf-btn correct' : ' review-tf-btn incorrect';
                    } else if (userChoice === 'S') {
                        falseBtnClass += isCorrect ? ' review-tf-btn correct' : ' review-tf-btn incorrect';
                    }

                    optionsHTML += `<div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                        <p><span class="font-bold mr-2 text-[#5C6BC0]">${optionLabels[optIndex]}</span> ${opt.text}</p>
                        <div class="flex space-x-2">
                            <span class="${trueBtnClass}">Đúng</span>
                            <span class="${falseBtnClass}">Sai</span>
                        </div>
                    </div>`;
                });
            }
            optionsHTML += `</div>`;
            reviewBlock.innerHTML = optionsHTML;
            reviewContainer.appendChild(reviewBlock);
        });
    }
    
    function handleCopy() {
        const scoreText = finalScore.textContent;
        const timeText = timeTakenEl.textContent.split(': ')[1] || 'N/A';
        const textToCopy = `${currentUser.name} ${currentUser.class} ${timeText} ${scoreText}`;
        
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'fixed';
        textArea.style.top = '-9999px';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                copyFeedback.style.opacity = '1';
                setTimeout(() => { copyFeedback.style.opacity = '0'; }, 2000);
            }
        } catch (err) {
            console.error('Không thể sao chép', err);
        }

        document.body.removeChild(textArea);
    }
    
    // --- KHỞI TẠO & SỰ KIỆN ---
    document.addEventListener('DOMContentLoaded', () => {
        initLoginScreen();
        classSelectBtn.addEventListener('click', () => toggleDropdown(classSelectOptions));
        studentSelectBtn.addEventListener('click', () => toggleDropdown(studentSelectOptions));
        
        window.addEventListener('click', function(e) {
            if (!classSelectBtn.contains(e.target) && !classSelectOptions.contains(e.target)) {
                classSelectOptions.classList.add('opacity-0', 'scale-95');
                setTimeout(() => classSelectOptions.classList.add('hidden'), 200);
            }
            if (!studentSelectBtn.contains(e.target) && !studentSelectOptions.contains(e.target)) {
                studentSelectOptions.classList.add('opacity-0', 'scale-95');
                setTimeout(() => studentSelectOptions.classList.add('hidden'), 200);
            }
        });

        startButton.addEventListener('click', startQuiz);
        nextButton.addEventListener('click', handleNextButtonClick);
        copyButton.addEventListener('click', handleCopy);
        endButton.addEventListener('click', initLoginScreen);
    });
    </script>
</body>
</html>
